<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  </head>
  <body>
    <div class="sidebar">
      <form>
        <input id="include-branded" type="checkbox" name="include-branded">
        <label for="include-branded">Include branded foods</label>
        <input id="description" type="text" name="description" style="width: 100%">
        <label for="description">Description</label>
        <input id="brand" type="text" name="brand" style="width: 100%" disabled>
        <label for="brand">Brand</label>
        <input id="serving-size" type="text" name="serving-size" style="width: 100%" disabled>
        <label for="serving-size">Serving size</label>
        <input id="ingredients" type="text" name="ingredients" style="width: 100%" disabled>
        <label for="ingredients">Ingredients</label>
        <button class="action" id="add-ingredient">Add ingredient</button>
        <button id="more-details">More details</button>
      </form>
    </div>

    <script>
      function handleNutrientNames(nutrientNames) {
        nutrientNames.forEach(function(name) {
          let input = $('<input>', {
            id: name.id,
            name: name.id,
            disabled: true,
            style: 'width: 100%',
            type: 'text',
          });
          $('#add-ingredient').before(input);

          let label = $('<label></label>', {
            for: name.id,
          });
          label.text(name.name);
          $('#add-ingredient').before(label);
        })
      }
      let currentDetails = null;
      function handleFoodDetails(details) {
        currentDetails = details;
        $('#more-details').on('click', function(event) {
          window.open(details.linkUrl, '_blank');
        });
        $('#description').val(details.description);
        $('#brand').val(details.brandOwner);
        $('#serving-size').val(details.householdServing);
        $('#ingredients').val(details.ingredients);
        details.nutrients.forEach(nutrient => {
          $('#' + nutrient.id.toString()).val(nutrient.amount);
        });
      }
      window.onload = function() {
        $('#description').autocomplete({
          source: function(request, response) {
            function handleSearchResults(results) {
              response(results.map(function(details) {
                return {label: details.description, value: details.fdcId};
              }));
            }
            google.script.run.withSuccessHandler(handleSearchResults).getSearchResults(
              request.term, $('#include-branded').is(':checked'));
          },
          select: function(event, ui) {
            event.preventDefault();
            let fdcId = Number(ui.item.value);
            google.script.run
            .withSuccessHandler(handleFoodDetails)
            .getFoodDetails(fdcId);
          },
        });
        $('#description').focus();
        google.script.run
        .withSuccessHandler(handleNutrientNames)
        .getNutrientNames();
      };
      document.getElementById('add-ingredient').addEventListener('click', function(event) {
        if (currentDetails != null) {
          google.script.run.addIngredient(currentDetails.fdcId, currentDetails.description);
        }
      })
    </script>
  </body>
</html>