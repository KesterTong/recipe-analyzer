<html>
  <head>
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
    crossorigin="anonymous"></script>
  </head>
  <body>
    <input id="include-branded" type="checkbox" name="include-branded">
    <label for="include-branded">Include Branded foods</label>
    <input id="search-query" type="text" style="width: 100%;display: inline-block;">
    <select id="search-results" size=8 style="width: 100%"></select>
    <div class="block form-group">
      <label for="description">Description</label><a id="link" target="_blank">ðŸ”—</a>
      <input id="description" type="text" name="description" style="width: 90%" disabled>
      <label for="brand">Brand</label>
      <input id="brand" type="text" name="brand" style="width: 100%" disabled>
      <label for="serving-size">Serving Size</label>
      <input id="serving-size" type="text" name="serving-size" style="width: 100%" disabled>
      <label for="ingredients">Ingredients</label>
      <input id="ingredients" type="text" name="ingredients" style="width: 100%" disabled>
      <pre id="measures"></pre>
    </div>
    <button class="action" id="add-ingredient">Add Ingredient</button>

    <script>
      function handleSearchResults(queryResults) {
        $('#search-results').empty();
        queryResults.forEach(function(details) {
          var option = $('<option></option>', {value: details.fdcId});
          option.text(details.description);
          $('#search-results').append(option);
        });
      }
      function handleFoodDetails(details) {
        let fdcLinkUrl = 'https://fdc.nal.usda.gov/fdc-app.html#/food-details/' + details.fdcId + '/nutrients';
        $('#link').attr('href', fdcLinkUrl);
        $('#description').val(details.description);
        if (details.dataType == 'Branded') {
          $('#brand').val(details.brandOwner);
          $('#serving-size').val(details.householdServing);
          $('#ingredients').val(details.ingredients);
          $('#measures').empty();
        } else if (details.dataType == 'SR Legacy') {
          $('#serving-size').val('100 g');
          let portionText = '';
          details.foodPortions.forEach(function(foodPortion) {
            portionText += foodPortion.amount + ' ' + foodPortion.modifier;
            portionText += ' = ' + foodPortion.gramWeight + 'g\n';
          });
          $('#measures').text(portionText);
        }
      }
      function getSearchResults() {
        google.script.run.withSuccessHandler(handleSearchResults).getSearchResults(
            $('#search-query').val(), $('#include-branded').is(':checked'));
      }
      function debounce(fn, delay) {
        let timeout = null;
        return function() {
          clearTimeout(timeout);
          timeout = setTimeout(function() {
            timeout = null;
            fn();
          }, delay);
        }
      };
      window.onload = function() {
        $('#search-query').focus();
      };
      $('#include-branded').on('change', getSearchResults);
      $('#search-query').on('keyup', debounce(getSearchResults));
      $('#search-results').on('change', function(event) {
        let fdcId = Number(event.target.value);
        google.script.run
        .withSuccessHandler(handleFoodDetails)
        .getFoodDetails(fdcId);
      });
      document.getElementById('add-ingredient').addEventListener('click', function(event) {
        let fdcId = $('#search-results').val();
        let description = $("#search-results option:selected").text();
        if (fdcId) {
          google.script.run.addIngredient(fdcId, description);
        }
      })
    </script>
  </body>
</html>