<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <style>
      .block .form-group {
        width: 100%;
      }
      input, select {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <form>
        <div class="block form-group">
          <label for="description">Description</label>
          <input id="description" type="text" name="description">
        </div>
        <div class="block form-group">
          <label for="amount">Amount</label>
          <input type="text" id="amount" name="amount">
        </div>
        <div class="block form-group">
          <label for="unit">Unit</label>
          <select id="unit" name="unit">
            <option>grams</option>
            <option>mL</option>
          </select>
        </div>
        <p>
          <b>Brand: </b>
          <span id="brand"></span>
        </p>
        <p>
          <b>Ingredients: </b>
          <span id="ingredients"></span>
        </p>
        <div class="block" id="button-bar">
          <button class="action" id="insert-ingredient">Insert ingredient</button>
          <button id="more-details">Details</button>
        </div>
      </form>
    </div>

    <script>
      function handleNutrientNames(nutrientNames) {
        nutrientNames.forEach(function(name) {
          let label = $('<b></b>').text(name.name + ': ');
          let amount = $('<span></span>', {id: 'nutrient-' + name.id});
          $('#button-bar').before($('<p></p>').append([label, amount]));
        })
      }
      let currentDetails = null;

      function handleQuantityChange() {
        let unit = $('#unit').val();
        // TODO: do this computation server side.
        let servings = Number($('#amount').val()) / currentDetails.servingEquivalentQuantities[unit];
        for (let id in currentDetails.nutrientsPerServing) {
          let value = servings * currentDetails.nutrientsPerServing[id];
          $('#nutrient-' + id).text(value);
        }
      }
      $('#amount').on('keyup', handleQuantityChange);
      $('#unit').on('change', handleQuantityChange);

      let linkUrl;
      let target;
      $('#more-details').on('click', function(event) {
        window.open(linkUrl, target);
      });

      function handleFoodDetails(details) {
        currentDetails = details;
        switch (details.foodIdentifier.foodType) {
          case 'Local Food':
            linkUrl = '#bookmark=' + foodDetails.foodIdentifier.bookmarkId;
            break;
          case 'FDC Food':
            linkUrl = 'https://fdc.nal.usda.gov/fdc-app.html#/food-details/' + details.foodIdentifier.fdcId + '/nutrients';
            target = '_blank';
            break;
        }
        $('#description').val(details.description);
        $('#brand').text(details.brandOwner);
        $('#ingredients').text(details.ingredients);
        $('#unit').empty()
        for (let unit in details.servingEquivalentQuantities) {
          $('#unit').append($('<option></option>').text(unit));
        }
        $('#unit').val('g');
        $('#amount').val(100);
        handleQuantityChange();
      }
      window.onload = function() {
        $('#description').autocomplete({
          source: function(request, response) {
            function handleSearchResults(results) {
              response(results.map(function(details) {
                return {
                  label: details.description,
                  value: details.foodIdentifier.fdcId || details.foodIdentifier.bookmarkId
                };
              }));
            }
            google.script.run.withSuccessHandler(handleSearchResults).getSearchResults(
              request.term, true /** includeBranded */);
          },
          select: function(event, ui) {
            event.preventDefault();
            let foodIdentifier;
            if (isNaN(ui.item.value)) {
              foodIdentifier = {foodType: 'Local Food', bookmarkId: ui.item.value};
            } else {
              foodIdentifier = {foodType: 'FDC Food', fdcId: Number(ui.item.value)};
            }
            google.script.run
            .withSuccessHandler(handleFoodDetails)
            .getFoodDetails(foodIdentifier);
          },
        });
        $('#description').focus();
        google.script.run
        .withSuccessHandler(handleNutrientNames)
        .getNutrientNames();
      };
      document.getElementById('insert-ingredient').addEventListener('click', function(event) {
        if (currentDetails != null) {
          // Fetch description from text input so that user can override description
          // when inserting ingredient.
          let description = $('#description').val();
          // TODO: parse this server side.
          let amount = Number($('#amount').val());
          let unit = $('#unit').val()
          google.script.run.addIngredient(currentDetails.foodIdentifier, amount, unit, description);
        }
      })
    </script>
  </body>
</html>