<html>
  <head>
    <script
  src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
  integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
  crossorigin="anonymous"></script>
  </head>
  <body>
    <input id="include-branded" type="checkbox" name="include-branded">
    <label for="include-branded">Include Branded foods</label>
    <input id="search-query" type="text" style="width: 100%;display: inline-block;">
    <select id="search-results" size=15 style="width: 49%"></select>
    <div id="search-details" style="width: 49%;height: 200px; overflow: auto; display: inline-block">Details</div>
    <button id="add-ingredient">Add Ingredient</button>

    <script>
      let detailsByFdcId = {};
      function onSuccess(queryResults) {
        detailsByFdcId = {}
        $('#search-results').empty();
        queryResults.forEach(function(details) {
          detailsByFdcId[details.fdcId] = details;
          var option = $('<option></option>', {value: details.fdcId});
          option.text(details.description);
          $('#search-results').append(option);
        });
      }
      function getSearchResults() {
        google.script.run.withSuccessHandler(onSuccess).getSearchResults(
            $('#search-query').val(), $('#include-branded').is(':checked'));
      }
      function debounce(fn, delay) {
        let timeout = null;
        return function() {
          clearTimeout(timeout);
          timeout = setTimeout(function() {
            timeout = null;
            fn();
          }, delay);
        }
      };
      window.onload = function() {
        $('#search-query').focus();
      };
      $('#include-branded').on('change', getSearchResults);
      $('#search-query').on('keyup', debounce(getSearchResults));
      $('#search-results').on('change', function(event) {
        let fdcId = Number(event.target.value);
        let details = detailsByFdcId[fdcId];
        let detailsString = ''
        Object.keys(details).forEach(function(key) {
          detailsString += key + ': ' + details[key] + '\n';
        })
        $('#search-details').text(detailsString);
      });
      document.getElementById('add-ingredient').addEventListener('click', function(event) {
        let fdcId = $('#search-results').val();
        if (!fdcId) {
          return;
        }
        let details = detailsByFdcId[fdcId];
        if (!details) {
          return;
        }
        google.script.run.withSuccessHandler(google.script.host.close).addIngredient(
            fdcId, details.description);
      })
    </script>
  </body>
</html>