<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <style>
      .block .form-group {
        width: 100%;
      }
      input, select {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <form>
        <div class="block form-group">
          <label for="description">Description</label>
          <input id="description" type="text" name="description">
        </div>
        <div class="block">
          <label for="serving-size">Serving size</label>
          <input id="serving-size" type="text" name="serving-size">
        </div>
        <div class="block">
          <label for="serving-size-unit">Serving size unit</label>
          <select id="serving-size-unit" type="text" name="serving-size-unit">
            <option>g</option>
            <option>ml</option>
          </select>
        </div>
        <div class="block">
          <label for="household-serving-full-text">Serving size</label>
          <input id="household-serving-full-text" type="text" name="household-serving-full-text">
        </div>
        <div class="block" id="button-bar">
          <button class="action" id="save">Save</button>
          <button id="cancel">Cancel</button>
        </div>
      </form>
    </div>
    <script>
      let bookmarkId = <?= bookmarkId ?>;
      function handleFoodDetails(details) {
        $('#description').val(details.description);
        $('#serving-size').val(details.servingSize);
        $('#serving-size-unit').val(details.servingSizeUnit);
        $('#household-serving-full-text').val(details.householdServingFullText);
        details.foodNutrients.forEach(function(foodNutrient) {
          let name = 'nutrient-' + foodNutrient.nutrient.id.toString();
          let label = $('<label></label>', {for: name}).text(name);
          let amount = $('<input></input>', {
            id: name,
            name: name,
            type: 'text',
            class: 'nutrient-value',
          });
          amount.data('id', foodNutrient.nutrient.id);
          amount.val(details.servingSize * foodNutrient.amount / 100.0);
          $('#button-bar').before($('<div></div>', {class: 'block'}).append([label, amount]));
        })
      }
      $('#save').click(function(event) {
        let servingSize = Number($('#serving-size').val());
        let foodNutrients = $('.nutrient-value').map(function() {
          return {
            nutrient: {id: $(this).data('id')},
            amount: 100.0 * Number($(this).val()) / servingSize,
          };
        }).toArray();
        let food = {
          dataType: 'Branded',
          description: $('#description').val(),
          servingSize: servingSize,
          servingSizeUnit: $('#serving-size-unit').val(),
          householdServingFullText: $('#household-serving-full-text').val(),
          foodNutrients: foodNutrients,
        };
        google.script.run
            .patchFood({
              identifierType: 'BookmarkId',
              bookmarkId: bookmarkId,
            }, food);
      });
      google.script.run
            .withSuccessHandler(handleFoodDetails)
            .getFoodDetails({
              identifierType: 'BookmarkId',
              bookmarkId: bookmarkId,
            });
    </script>
  </body>
</html>